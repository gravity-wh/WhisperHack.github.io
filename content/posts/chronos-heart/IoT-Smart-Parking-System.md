基于物联网的智慧停车系统得到了广泛的应用，可以实时探测车位的车辆是否被占用，并显示剩余车辆数量。要求基于嵌入式系统构成物联网，实现对车位停车的监测。

系统采用超声波雷达探测，由RS485总线将数据传输给上位机，上位机处理显示并驱动显示单元进行显示。同时嵌入式系统一般更改程序是在嵌入式系统产品定型时直接烧录的。然而，在实际应用中嵌入式MCU需要具有远程程序升级功能，避免拆装单片机产品或召回升级。

因此，需要对MCU加入Bootloader功能，采用无线4G/5G网络实现对MCU的远程升级。结合商用4G/5G无线模块，开发相关无线网络应用程序，以适应不同的通信接口，使得嵌入式系统具有在线远程升级功能。

## 原理与方案调研

### 基于MCU的超声波雷达探测原理

### RS485通信协议

#### 什么是RS485？

一种信号传输方式，OSI模型的第一层级。

串行RS-485的连接是使用两根或者三根电缆，实现差分信号的传输。这种方式可以抑制共模干扰信号，提高信号传输的抗干扰能力。

- DATA+
- DATA-
- GND

#### RS485通信物理链路构成

RS485采用半双工的工作方式，即数据双向传输但不能同时进行，一条通讯线路支持多点数据的通信。

RS485的总线网络拓扑一般采用终端匹配的总线型结构，即一条总线将各个节点手牵手连接起来。

理论上的最长传输距离是1200m。可以定义一个主站和最多32个从站【那么问题来了，显然要检测的目标超过32个，需要多个组网】

### 嵌入式系统IAP的BootLoader工作原理

IAP（In-Application Programming，应用中编程）是 MCU 在运行过程中通过特定接口对自身 Flash 进行编程的核心技术。可实现设备固件的远程 / 本地升级，无需拆卸硬件，极大降低工业控制、物联网终端、智能硬件等场景的维护成本，是嵌入式设备迭代优化的关键能力。

### 文献资料

## 工程样机实现方案

一些亟待解决的问题：

正点原子STM32F407探索者开发板怎么连接RS485总线？

多个从机如何实现手牵手的总线结构？

### MCU主板

### 超声波雷达

通信格式：115200 n 8 1 ,意味着波特率为115200，无校验位，8位数据位，1位停止位。

Modbus-RTU协议数据帧结构

| 地址码 | 功能码 | 数据区 | CRC校验 |
| ------ | ------ | ------ | ------- |
| 1Byte  | 1Byte  | nBytes | 2Bytes  |

注：
| 地址码：从机地址，默认为0x01
| 功能码：0x03表示读取从机；0x06表示写入从机
| 数据区：包含起始地址、数据等
| CRC校验：范围为地址码到数据区的所有字节

功能寄存器地址配置表

| 地址   | 特性 | 功能         | 说明                                                              |
| ------ | ---- | ------------ | ----------------------------------------------------------------- |
| 0x0000 | R    | 超声波测距值 | 单位：mm                                                          |
| 0x0015 | R/W  | 从机地址     | 默认地址0x01，未知从机可以用0xFF代替，可设置地址范围0x0001~0xFFFF |

#### Modbus-RTU协议通信流程

主机可以进行的操作有：

1.将地址为0x0001的从机修改为地址0x0002

2.将未知地址的从机修改为地址0x0001

3.读取地址为0x0001的机器通道1的超声波测距值(难道说同一个地址有多个通道？)

从机响应格式：

| 数据帧 | 地址码 | 功能码 | 字节数 | 数据区 | CRC校验 |
| ------ | ------ | ------ | ------ | ------ | ------- |

Example1:主机读取地址为ox0001设备的超声波测距值

1. 主机发送读取命令 n=4
   
   [20:57:20:824]发送：01 | 03 | 00 10 00 01 | 85 CF

   [20:57:20.844]接收：01 | 03 | 02 01 12 | 39 D9

2. 从机返回数据帧
   
   [20:57:20.888]接收：01 | 03 | 02 01 12 | 39 D9

- 此数据来自地址为01的从机
- 功能码为0x03，R
- 数据长度0x02，长度为2
- 数据0x01 0x12，合并为0112，即为十进制数274，可得通道1测量的距离为274mm

#### RS485总线多从机接入方案

### 5G模块

#### 5G模块方案论证

##### 移远EC200U

[移远RG200U模块配置资料](https://doc.embedfire.com/linux/rk356x/quick_start/zh/latest/quick_start/wireless/5g/5g.html#rg200u)

##### QuecPython 开发框架

QuecPython 是移远通信推出的基于 MicroPython 的开发框架，为开发者提供了简单易用的 API 接口。这里埋个包袱，能不能用它来实现Bootloader的远程升级功能？累了，今天就整理到这里。

- 第一次更新时间戳：2025-12-18 22:02:00（UTC+8）

## 落地计划

- RS485总线如何将信息打包封装
- 实现多从站接入后的轮询
- 实现5G模块的连接
